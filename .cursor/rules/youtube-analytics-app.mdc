---
alwaysApply: true
description: YouTube Analytics App development context and architecture guidelines
---

# YouTube Analytics App - Development Context

## Project Overview
This is a YouTube analytics app for creators that provides AI-powered insights, channel management, and video planning tools. The app features advanced text animation, real-time analytics, and an AI assistant named Neria.

## Tech Stack & Architecture
- **Framework**: Next.js 15.5.0 with App Router
- **Language**: TypeScript with strict typing
- **Styling**: Tailwind CSS 4.0 with responsive design patterns
- **Database**: Supabase (PostgreSQL) with Row Level Security (RLS)
- **Authentication**: Supabase Auth + Google OAuth (dual-phase authentication)
- **APIs**: YouTube Data API v3, YouTube Analytics API
- **AI**: OpenAI GPT-4o (primary), Perplexity (real-time web search only)
- **3D Graphics**: Spline (@splinetool/react-spline)

## Key Architecture Patterns

### Authentication Flow
Use dual-phase authentication to prevent Brand Account session hijacking:
1. **Phase 1**: Basic Google sign-in with minimal scopes → establishes primary user session
2. **Phase 2**: Popup-based YouTube OAuth → gets YouTube tokens but associates them with original user via `state` parameter

### Database Schema Relationships
Key tables and their relationships:
- `google_accounts`: user_id, google_sub, account_email, tokens, last_channel_used
- `channels`: user_id, channel_id, title, thumbnails, stats
- `chat_threads`: per-user and optional per-channel chat threads
- `chat_messages`: thread_id, role (user|assistant), content
- `memory_profile`: per-user+channel long-term profile (goals, preferences)
- `channel_strategy`: per-user+channel persisted coaching plans
- `video_plans`: stored video ideas with AI-generated summaries
- `scripts`: LLM-generated video flows with sections and resources

### Component Architecture
- **Layout Components**: Use `DashboardLayout` for dashboard pages with sidebar navigation
- **AI Components**: `NeriaContainer` (floating chat), `NeriaResponse` (animated text)
- **Data Components**: `YouTubeStats` (analytics), `PlannerClient` (video ideas)
- **UI Components**: Follow responsive design with fixed sidebar (213px) and flex main content

## Development Guidelines

### React & Next.js Best Practices
- Prevent hydration mismatch errors with proper loading states
- Use Server Components where possible, Client Components only when needed
- Implement proper error boundaries and loading states
- Follow App Router conventions for file-based routing

### Animation System
The app features sophisticated character-by-character text animation:
- **Batch-Based Animation**: Text appears in 2-sentence chunks with intelligent pauses
- **Punctuation Timing**: 1-second pauses after periods/exclamation marks, 0.5-second pauses after commas
- **Unicode Filtering**: Remove problematic Unicode characters and replacement symbols
- **Performance**: Use CSS transforms and will-change properties for smooth animations

### AI Integration Patterns
- **Streaming Responses**: Use Server-Sent Events (SSE) for real-time AI responses
- **Context Management**: Track conversation context with visual indicators
- **Model Routing**: GPT-4o primary, Perplexity only for real-time web search
- **Intent Detection**: Use AI-powered intent analysis instead of keyword matching

### Database Operations
- Always use Row Level Security (RLS) policies
- Implement proper foreign key relationships
- Use database transactions for multi-table operations
- Include proper error handling and validation

### API Route Patterns
- Use proper HTTP methods (GET, POST, PUT, DELETE)
- Implement authentication checks on all protected routes
- Return consistent JSON response formats
- Handle errors gracefully with appropriate status codes

### UI/UX Guidelines
- **Responsive Design**: Mobile-first approach with Tailwind breakpoints
- **No Scrollbars**: Use fixed header/footer with flex-1 main content
- **Loading States**: Show appropriate loading indicators during async operations
- **Error Handling**: Display user-friendly error messages

## File Structure Reference
```
src/
├── app/
│   ├── auth/                    # Authentication routes
│   ├── api/                     # API endpoints
│   │   ├── neria/               # AI assistant endpoints
│   │   ├── youtube-*            # YouTube integration
│   │   └── [feature]/           # Feature-specific APIs
│   ├── dashboard/               # Main dashboard pages
│   │   └── [channelId]/         # Channel-specific routes
│   └── [page]/                  # Public pages
├── components/                  # Reusable components
│   ├── Dashboard*.tsx           # Dashboard-specific components
│   ├── Neria*.tsx              # AI assistant components
│   └── [Feature]*.tsx          # Feature components
└── utils/                       # Utility functions
    ├── supabase/               # Database clients
    └── [service].ts            # Service utilities
```

## Environment Variables
Required environment variables for development:
```env
NEXT_PUBLIC_SUPABASE_URL=https://vmgjrvwwfcomhexlgwds.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[anon_key]
SUPABASE_SERVICE_ROLE_KEY=[service_role_key]
NEXT_PUBLIC_GOOGLE_CLIENT_ID=[google_client_id]
GOOGLE_CLIENT_ID=[google_client_id]
GOOGLE_CLIENT_SECRET=[google_client_secret]
GEMINI_API_KEY=[gemini_api_key]
```

## Common Issues & Solutions

### Authentication Issues
- **"invalid_client"**: Check Google Client ID/Secret in environment variables
- **"redirect_uri_mismatch"**: Ensure redirect URIs match Google Console exactly
- **Session replacement**: Use popup-based OAuth for secondary authentications

### React & Hydration Issues
- **Hydration mismatch**: Ensure server and client render identical content initially
- **Unicode characters**: App automatically filters problematic Unicode from AI responses
- **Animation timing**: Use cumulative delays with punctuation pauses

### Database Maintenance
When examining database schema with Supabase MCP:
1. Compare results against tables in `/api/wipe-all-data/route.ts`
2. Update wipe API to include any missing user-specific tables
3. Include tables with `user_id` or `channel_id` foreign keys
4. Exclude system tables (`model_settings`, `model_providers`, etc.)

## Development Workflow
1. Use semantic search to understand existing code patterns
2. Follow established component and API patterns
3. Test authentication flows thoroughly
4. Verify responsive design across breakpoints
5. Ensure proper error handling and loading states
6. Test AI features with context awareness

## Code Quality Standards
- Use TypeScript strict mode with proper typing
- Follow ESLint configuration rules
- Implement proper error boundaries
- Use consistent naming conventions
- Document complex business logic
- Test edge cases, especially authentication flows

This context document should guide all development decisions and ensure consistency across the YouTube Analytics App codebase.

## Feature: Collection system (/collection)

### Overview
- Page: `src/app/collection/page.tsx`
- API: `src/app/api/collection/preview/route.ts`
- Purpose: Present a multi-slide collection preview with Neria’s animated greeting and channel metadata.

### Timing & Animation
- Slide 1 timing is dynamic: waits for `NeriaResponse` animation to finish via `onComplete`, then adds a 5s buffer before auto-advancing.
- Other slides default to 9000ms.
- Progress bar is inside the metadata section and is driven via `requestAnimationFrame` scaling on the X axis.
- Metadata entrance animation triggers on first data load: container is `overflow-y-hidden`; title row, description, each stat label, and each stat value fade in and translate up with a slight stagger.
- Reduced motion: if `prefers-reduced-motion` is enabled, the auto-advance/progress animation is disabled.

### UI Details
- Pagination dots: inactive have transparent fill with a 2px black border; active have black fill and a 2px black border.
- Description is limited to the first sentence of the channel description.
- Stat formatting:
  - 0–999: full number (e.g., 850)
  - 1,000–99,999: 1 decimal with k (e.g., 2.5k, 68.3k)
  - 100,000–999,999: whole-number k (e.g., 258k)
  - ≥1,000,000: 1 decimal with M (e.g., 1.1M)
- Stat icons use fixed height with `object-contain` to preserve aspect ratio and align labels; metadata block is top-aligned.
- Layout includes ~70px bottom padding under the metadata for breathing room.

### Slides Implementation

#### Slide 1 (Channel Overview)
- Channel metadata with animated entrance
- Neria greeting with system prompt `collection_greeting`
- Timer starts after animation completes + 5s buffer

#### Slide 2 (Top Performer Analysis)
- Left: 250px video card showing best performer by viewsPerDay (90d normalized)
- Right: Neria insight using system prompt `collection_winners_theme`
- Timer starts after Neria animation completes
- Analyzes up to 10 top video titles to infer dominant successful themes

#### Slide 3 (Underperformer Analysis)
- Left: 250px video card showing worst performer by viewsPerDay
- Right: Neria diagnosis using system prompt `collection_losers_theme`
- Lazy loads single worst video via `/api/collection/losers`
- Timer pauses during loading, starts after animation completes

### API Endpoints
- `/api/collection/preview`: Main data bundle (channel + analytics + winners + slide text)
- `/api/collection/losers`: Lazy load worst performer details for Slide 3
- Both use YouTube Analytics API with 90-day window and viewsPerDay ranking

### System Prompts Integration
- All slide text generated server-side using `system_prompts` table
- Prompts editable via dashboard system-prompts page
- Fallback text available if prompt generation fails

### Key Components/State
- Uses `NeriaResponse` for animated text with batching and punctuation-aware delays
- Local state: `activeSlide`, `slide1Done`, `slide2Done`, `slide3Done`, `metaAnim`, `pauseTimer`, `userInteractedAt`
- Constants: `DEFAULT_SLIDE_DURATION_MS=9000`, `SLIDE1_BUFFER_MS=5000`, `SLIDE_COUNT=5`